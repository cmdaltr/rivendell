# Docker Compose Override for Testing on 16GB Macs
# This configuration disables heavy SIEM services to save 6GB+ RAM
#
# Usage (from repo root):
#   docker-compose -f docker-compose.yml -f tests/docker-compose.testing.yml up -d
#
# Or set as default:
#   export COMPOSE_FILE=docker-compose.yml:tests/docker-compose.testing.yml
#   docker-compose up -d

services:
  # Reduce celery-worker memory from 8G to 6G
  # Remove SIEM dependencies since we're disabling them in testing mode
  celery-worker:
    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_started
      backend:
        condition: service_started
    volumes:
      - ./src/web/backend:/app
      - /Volumes:/Volumes
      - /tmp/rivendell:/tmp/elrond/output
      - /tmp/rivendell:/tmp/rivendell
      - ./fixtures:/tmp/rivendell/fixtures:ro
      - rivendell_uploads:/tmp/elrond/uploads
      - navigator_data:/navigator
      # NOTE: splunk volumes removed in testing mode
    deploy:
      resources:
        limits:
          memory: 6G  # Reduced from 8G
        reservations:
          memory: 1G

  # Replace Splunk with a no-op container to satisfy dependency
  splunk:
    image: alpine:latest
    container_name: rivendell-splunk-stub
    command: /bin/sh -c "echo 'Splunk disabled in testing mode' && sleep infinity"
    restart: "no"
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 16M

  # Replace Elastic with a no-op container to satisfy dependency
  elastic:
    image: alpine:latest
    container_name: rivendell-elastic-stub
    command: /bin/sh -c "echo 'Elasticsearch disabled in testing mode' && sleep infinity"
    restart: "no"
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 16M

  # Disable Kibana
  kibana:
    profiles:
      - siem-testing

  # Disable Elastic setup container
  elastic-setup:
    profiles:
      - siem-testing

  # Disable Kibana setup container
  kibana-setup:
    profiles:
      - siem-testing

  # Disable Navigator (ATT&CK Navigator)
  navigator:
    profiles:
      - optional
