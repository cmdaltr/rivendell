# Rivendell AI Agent Configuration
# AI-powered forensic analysis agent settings

ai_agent:
  # Enable/disable AI agent
  enabled: true

  # LLM Model Configuration
  model:
    # Model type: 'local' (llamacpp/ollama) or 'api' (OpenAI, Anthropic)
    type: local

    # For local models - LlamaCpp
    llamacpp:
      # Path to GGUF model file
      model_path: "/opt/rivendell/models/llama-3-70b.gguf"
      # Context window size
      context_length: 4096
      # Batch size for processing
      batch_size: 512
      # GPU layers to offload (-1 = all)
      n_gpu_layers: -1

    # For local models - Ollama (recommended for easier setup)
    ollama:
      # Model name (ollama pull <model>)
      model_name: "llama3"
      # Ollama host
      host: "http://localhost:11434"

    # For API-based models (optional, not recommended for privacy)
    api:
      provider: "openai"  # openai, anthropic
      api_key: "${OPENAI_API_KEY}"
      model_name: "gpt-4"
      endpoint: "https://api.openai.com/v1"

    # Generation parameters
    temperature: 0.1  # Lower = more factual, higher = more creative
    max_tokens: 2048  # Maximum tokens to generate
    top_p: 0.9
    frequency_penalty: 0.0
    presence_penalty: 0.0

  # Embedding Model Configuration
  embedding:
    # Embedding model for vector search
    model: "sentence-transformers/all-MiniLM-L6-v2"
    # Alternative models:
    # - "sentence-transformers/all-mpnet-base-v2" (better quality, slower)
    # - "BAAI/bge-small-en-v1.5" (good balance)

    # Device: cpu, cuda, mps
    device: "cpu"

    # Batch size for embedding
    batch_size: 32

  # Vector Database Configuration
  vector_db:
    # Vector DB type: chroma, qdrant, faiss
    type: "chroma"

    # Storage location
    persist_dir: "/opt/rivendell/data/vector_db"

    # Collection name prefix
    collection_prefix: "case_"

    # Distance metric: cosine, euclidean, ip
    distance_metric: "cosine"

    # Qdrant-specific settings (if using qdrant)
    qdrant:
      host: "localhost"
      port: 6333
      grpc_port: 6334

  # Indexing Configuration
  indexing:
    # Automatically index artifacts after analysis
    auto_index: true

    # Index when analysis completes
    index_on_analysis_complete: true

    # Artifact types to index
    artifacts_to_index:
      - timeline          # Timeline events
      - iocs              # Indicators of Compromise
      - processes         # Process information
      - network           # Network connections
      - registry          # Registry keys (Windows)
      - files             # File listings
      - cloud_logs        # Cloud audit logs
      - memory_strings    # Memory strings
      - browser_history   # Browser history

    # Text chunking for large documents
    chunk_size: 1000
    chunk_overlap: 200

    # Maximum documents to index per artifact type (0 = unlimited)
    max_docs_per_type: 0

  # Query Configuration
  query:
    # Number of similar documents to retrieve
    top_k: 10

    # Minimum relevance score (0.0 to 1.0)
    min_relevance_score: 0.0

    # Query timeout (seconds)
    timeout: 120

    # Enable query caching
    cache_enabled: true
    cache_ttl: 3600  # seconds

    # Stream responses (for web interface)
    stream_responses: false

  # Web Interface Configuration
  web_interface:
    # Enable web interface
    enabled: true

    # Host to bind to
    host: "0.0.0.0"

    # Port to listen on
    port: 5687

    # Enable WebSocket support
    websocket_enabled: true

    # CORS settings
    cors:
      enabled: true
      allow_origins:
        - "http://localhost:3000"
        - "http://localhost:8000"
      allow_credentials: true

    # Session timeout (minutes)
    session_timeout: 60

    # Max concurrent connections
    max_connections: 100

  # CLI Configuration
  cli:
    # Default output format: text, json, markdown
    default_format: "text"

    # Show sources by default
    show_sources: true

    # Verbose output
    verbose: false

    # Color output
    color_enabled: true

  # Privacy and Security
  privacy:
    # Run locally only (no external API calls)
    local_only: true

    # Disable external API access
    no_external_apis: true

    # Data retention period (days)
    data_retention_days: 365

    # Anonymize sensitive data in logs
    anonymize_logs: true

    # Encryption for stored vectors
    encrypt_vectors: false

  # Performance Tuning
  performance:
    # Number of worker threads
    num_workers: 4

    # Memory limit (MB, 0 = unlimited)
    memory_limit: 0

    # Enable GPU acceleration
    gpu_acceleration: false

    # GPU device ID
    gpu_device_id: 0

    # Prefetch documents during queries
    prefetch_enabled: true

  # Logging
  logging:
    # Log level: DEBUG, INFO, WARNING, ERROR
    level: "INFO"

    # Log file location
    log_file: "/opt/rivendell/logs/ai_agent.log"

    # Log rotation
    rotate: true
    max_bytes: 10485760  # 10 MB
    backup_count: 5

    # Log format
    format: "[%(asctime)s] %(levelname)s - %(name)s - %(message)s"

  # Forensic-Specific Settings
  forensic:
    # MITRE ATT&CK integration
    mitre_attck:
      enabled: true
      # Automatically map events to techniques
      auto_mapping: true

    # IOC extraction from queries
    ioc_extraction:
      enabled: true
      # Extract IPs, domains, hashes, etc. from responses
      auto_extract: true

    # Timeline correlation
    timeline_correlation:
      enabled: true
      # Time window for correlation (minutes)
      time_window: 60

    # Chain of custody
    chain_of_custody:
      enabled: true
      # Log all queries and responses
      log_queries: true
      # Include query metadata
      include_metadata: true

  # Example Queries (shown in web interface)
  example_queries:
    - "What PowerShell commands were executed?"
    - "Show me all network connections to external IPs"
    - "What files were created in the last hour before the incident?"
    - "Which processes were running at 2025-11-12 14:30:00?"
    - "What events are related to IP address 192.168.1.100?"
    - "Show me all activity by user 'administrator'"
    - "What MITRE ATT&CK techniques were detected?"
    - "What persistence mechanisms were found?"
    - "Show me evidence of lateral movement"
    - "What data exfiltration indicators are present?"
    - "Summarize the attack timeline"
    - "What are the key findings?"
    - "What should I investigate next?"

  # Prompt Templates (advanced)
  prompts:
    # System prompt for forensic analysis
    system: |
      You are an expert digital forensics analyst assisting with a forensic investigation.
      Your role is to analyze evidence, identify suspicious activities, and provide
      actionable insights based on the artifacts and data collected.

      Always:
      - Base your answers on the provided evidence
      - Cite your sources with timestamps and artifact types
      - Identify relevant MITRE ATT&CK techniques
      - Highlight security concerns and red flags
      - Suggest follow-up investigation steps

      Never:
      - Speculate without evidence
      - Provide legal advice
      - Make definitive conclusions without sufficient evidence

    # Query prompt template
    query: |
      You are analyzing case {case_id}.

      Context from investigation:
      {context}

      Analyst Question: {question}

      Provide a detailed forensic analysis answer including:
      1. Direct answer to the question
      2. Supporting evidence from the context
      3. Relevant timestamps or artifact sources
      4. Any security concerns or red flags
      5. Suggested follow-up investigation steps

      Answer:

    # Summary prompt template
    summary: |
      Generate a comprehensive case summary based on the investigation data.
      Include:
      1. Executive Summary (2-3 paragraphs)
      2. Key Findings (bullet points)
      3. Timeline Summary (chronological key events)
      4. MITRE ATT&CK Techniques Detected
      5. Recommendations for remediation

      Summary:
