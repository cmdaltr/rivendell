# Elrond Docker Compose Configuration
# Development environment with all services

version: '3.8'

services:
  # Redis - Message broker for Celery
  redis:
    image: redis:7-alpine
    container_name: elrond-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - elrond-network

  # PostgreSQL - Optional database (for future use)
  # Uncomment if you want to use PostgreSQL instead of file-based storage
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: elrond-postgres
  #   environment:
  #     POSTGRES_DB: elrond
  #     POSTGRES_USER: elrond
  #     POSTGRES_PASSWORD: elrond_pass
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U elrond"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: unless-stopped
  #   networks:
  #     - elrond-network

  # Backend API - FastAPI application
  backend:
    build:
      context: ../../web/backend
      dockerfile: Dockerfile
    container_name: elrond-backend
    ports:
      - "8000:8000"
    environment:
      - DEBUG=true
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ALLOWED_PATHS=/evidence,/mnt,/tmp/elrond
    volumes:
      - ../../web/backend:/app
      - elrond-evidence:/evidence
      - elrond-output:/output
      - elrond-uploads:/tmp/elrond/uploads
      - elrond-jobs:/tmp/elrond/jobs
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - elrond-network

  # Celery Worker - Background task processor
  celery-worker:
    build:
      context: ../web/backend
      dockerfile: Dockerfile
    container_name: elrond-celery-worker
    command: celery -A tasks.celery_app worker --loglevel=info --concurrency=2
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ELROND_NONINTERACTIVE=1
    volumes:
      - ../../web/backend:/app
      - elrond-evidence:/evidence
      - elrond-output:/output
      - elrond-uploads:/tmp/elrond/uploads
      - elrond-jobs:/tmp/elrond/jobs
      # Mount elrond forensics tools
      - ./:/opt/elrond:ro
    depends_on:
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - elrond-network

  # Frontend - React application
  frontend:
    build:
      context: ../web/frontend
      dockerfile: Dockerfile
      target: development
    container_name: elrond-frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8000
      - CHOKIDAR_USEPOLLING=true
    volumes:
      - ../../web/frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks:
      - elrond-network

  # Rivendell Forensics Engine (CLI)
  rivendell-cli:
    build:
      context: ../../..
      dockerfile: src/analysis/Dockerfile
    image: rivendell-cli:dev
    container_name: rivendell-cli
    privileged: true  # Required for mounting disk images
    cap_add:
      - SYS_ADMIN
      - SYS_RESOURCE
    devices:
      - /dev/fuse
    volumes:
      - elrond-evidence:/evidence
      - elrond-output:/output
      - elrond-cases:/cases
      - /mnt:/mnt:rshared  # Share mount namespace with host
    environment:
      - ELROND_HOME=/opt/elrond
      - ELROND_OUTPUT=/output
      - ELROND_EVIDENCE=/evidence
      - ELROND_NONINTERACTIVE=1
    command: ["bash", "-c", "tail -f /dev/null"]  # Keep container running
    restart: unless-stopped
    networks:
      - elrond-network

volumes:
  redis-data:
    driver: local
  # postgres-data:
  #   driver: local
  elrond-evidence:
    driver: local
  elrond-output:
    driver: local
  elrond-cases:
    driver: local
  elrond-uploads:
    driver: local
  elrond-jobs:
    driver: local

networks:
  elrond-network:
    driver: bridge
