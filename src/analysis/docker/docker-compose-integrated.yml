# Elrond Docker Compose - Fully Integrated Configuration
# Complete forensics platform with all components running from the same image

version: '3.8'

services:
  # Redis - Message broker for Celery
  redis:
    image: redis:7-alpine
    container_name: elrond-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - elrond-network

  # Backend API - FastAPI running in forensics container
  backend:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: elrond-backend
    ports:
      - "8000:8000"
    environment:
      - DEBUG=true
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ALLOWED_PATHS=/evidence,/mnt,/tmp/elrond,/output
      - PYTHONPATH=/opt/elrond
    volumes:
      - ../web/backend:/opt/elrond/web/backend
      - elrond-evidence:/evidence
      - elrond-output:/output
      - elrond-uploads:/tmp/elrond/uploads
      - elrond-jobs:/tmp/elrond/jobs
      - elrond-logs:/var/log/elrond
    command: ["python3", "-m", "uvicorn", "web.backend.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - elrond-network

  # Celery Worker - Forensic analysis processor
  celery-worker:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: elrond-celery-worker
    privileged: true  # Required for mounting disk images
    cap_add:
      - SYS_ADMIN
      - SYS_RESOURCE
    devices:
      - /dev/fuse
    command: ["python3", "-m", "celery", "-A", "web.backend.tasks.celery_app", "worker", "--loglevel=info", "--concurrency=2"]
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONPATH=/opt/elrond
      - ELROND_HOME=/opt/elrond
      - ELROND_OUTPUT=/output
      - ELROND_NONINTERACTIVE=1
      - ELROND_EVIDENCE=/evidence
    volumes:
      - ../web/backend:/opt/elrond/web/backend
      - elrond-evidence:/evidence
      - elrond-output:/output
      - elrond-uploads:/tmp/elrond/uploads
      - elrond-jobs:/tmp/elrond/jobs
      - elrond-logs:/var/log/elrond
      - /mnt:/mnt:rshared  # Share mount namespace for disk mounting
    depends_on:
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - elrond-network

  # Frontend - React application
  frontend:
    build:
      context: ../web/frontend
      dockerfile: Dockerfile
      target: development
    container_name: elrond-frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8000
      - CHOKIDAR_USEPOLLING=true
    volumes:
      - ../web/frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks:
      - elrond-network

  # Elrond CLI - Interactive forensics shell
  elrond-cli:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: elrond-cli
    privileged: true
    cap_add:
      - SYS_ADMIN
      - SYS_RESOURCE
    devices:
      - /dev/fuse
    volumes:
      - elrond-evidence:/evidence
      - elrond-output:/output
      - elrond-cases:/cases
      - elrond-logs:/var/log/elrond
      - /mnt:/mnt:rshared
    environment:
      - ELROND_HOME=/opt/elrond
      - ELROND_OUTPUT=/output
      - ELROND_EVIDENCE=/evidence
      - ELROND_CASES=/cases
    command: ["bash", "-c", "tail -f /dev/null"]  # Keep container running for exec access
    restart: unless-stopped
    networks:
      - elrond-network

volumes:
  redis-data:
    driver: local
  elrond-evidence:
    driver: local
  elrond-output:
    driver: local
  elrond-cases:
    driver: local
  elrond-uploads:
    driver: local
  elrond-jobs:
    driver: local
  elrond-logs:
    driver: local

networks:
  elrond-network:
    driver: bridge
