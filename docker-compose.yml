services:
  # PostgreSQL for job state storage
  postgres:
    image: postgres:16-alpine
    container_name: rivendell-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=rivendell
      - POSTGRES_USER=rivendell
      - POSTGRES_PASSWORD=rivendell
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - rivendell-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rivendell"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # Redis for Celery task queue
  redis:
    image: redis:7-alpine
    container_name: rivendell-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - rivendell-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M

  # Backend API
  backend:
    build:
      context: ./src/web/backend
      dockerfile: Dockerfile
    container_name: rivendell-backend
    ports:
      - "5688:5688"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DATABASE_URL=postgresql://rivendell:rivendell@postgres:5432/rivendell
    volumes:
      - ./src/web/backend:/app
      # Platform-specific mounts - uncomment for your OS:
      # - /mnt:/mnt:ro              # Linux: Mount points (read-only)
      # - /media:/media:ro          # Linux: Ubuntu/Debian mounts (read-only)
      - /Volumes:/Volumes:ro      # macOS: External drives (read-only)
      # - D:/:/mnt/d:ro             # Windows: Mount D: drive (example, adjust as needed)
      - /tmp/rivendell:/tmp/elrond/output  # Output directory (accessible at /tmp/rivendell on host)
      - /tmp/rivendell:/tmp/rivendell:ro  # Mount for test images in /tmp/rivendell
      - /tmp/rivendell:/host/tmp/rivendell  # Also mount at /host/tmp/rivendell for frontend compatibility
      - rivendell_uploads:/tmp/elrond/uploads  # Upload directory
    depends_on:
      - redis
      - postgres
    networks:
      - rivendell-network
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 5688 --reload
    deploy:
      resources:
        limits:
          memory: 256M

  # Celery worker for background tasks (forensics-enabled)
  celery-worker:
    build:
      context: .
      dockerfile: src/web/backend/Dockerfile.forensics
    container_name: rivendell-celery-worker
    privileged: true  # Required for mounting forensic images
    devices:
      - /dev/fuse:/dev/fuse  # Required for FUSE mounts
    cap_add:
      - SYS_ADMIN  # Required for loop device mounts
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DATABASE_URL=postgresql://rivendell:rivendell@postgres:5432/rivendell
      - SPLUNK_HOST=splunk
      - SPLUNK_PORT=8089
      - SPLUNK_USERNAME=admin
      - SPLUNK_PASSWORD=rivendell
      - ELASTICSEARCH_HOST=elastic
      - ELASTICSEARCH_PORT=9200
      - ELASTIC_USERNAME=elastic
      - ELASTIC_PASSWORD=rivendell
      # Set to 'true' to exclude cache directories from user profile copies (faster but less complete)
      - RIVENDELL_EXCLUDE_PROFILE_CACHE=true
    volumes:
      - ./src/web/backend:/app
      # NOTE: elrond source is now copied into the image during build (see Dockerfile.forensics)
      # to avoid OneDrive file locking conflicts with Docker VirtioFS on macOS
      # Platform-specific mounts - uncomment for your OS:
      # - /mnt:/mnt                 # Linux: Mount points (read-write for output)
      # - /media:/media             # Linux: Ubuntu/Debian mounts (read-write for output)
      - /Volumes:/Volumes           # macOS: External drives (read-write for output) - COMMENT OUT ON LINUX/WINDOWS
      # - D:/:/mnt/d                # Windows: Mount D: drive (example, adjust as needed)
      - /tmp/rivendell:/tmp/elrond/output  # Output directory (accessible at /tmp/rivendell on host)
      - /tmp/rivendell:/tmp/rivendell  # Mount for test images in /tmp/rivendell
      - ./fixtures:/tmp/rivendell/fixtures:ro  # Keywords, YARA rules, IOC watchlists for analysis
      - rivendell_uploads:/tmp/elrond/uploads  # For uploaded forensic images
      - splunk_etc:/opt/splunk/etc
      - splunk_var:/opt/splunk/var
      - navigator_data:/navigator  # Shared with navigator for ATT&CK Navigator JSON output
    depends_on:
      - redis
      - postgres
      - backend
      - splunk
      - elastic
    networks:
      - rivendell-network
    restart: unless-stopped
    # Override PYTHONPATH to prioritize /app over /opt/elrond-src to avoid module conflicts
    command: sh -c 'cd /app && PYTHONPATH=/app exec /usr/bin/python3 -m celery -A tasks_docker.celery_app worker --loglevel=info'
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G

  # Frontend
  frontend:
    build:
      context: ./src/web/frontend
      dockerfile: Dockerfile
    container_name: rivendell-frontend
    ports:
      - "5687:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:5688
    volumes:
      - ./src/web/frontend/src:/app/src
      - ./src/web/frontend/public:/app/public
    depends_on:
      - backend
    networks:
      - rivendell-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M

  # Splunk Enterprise
  splunk:
    image: splunk/splunk:latest
    container_name: rivendell-splunk
    hostname: splunk
    ports:
      - "8089:8089"  # Splunk API
      - "7755:8000"  # Splunk Web
      - "9997:9997"  # Splunk Forwarder
    environment:
      - SPLUNK_START_ARGS=--accept-license
      - SPLUNK_GENERAL_TERMS=--accept-sgt-current-at-splunk-com
      - SPLUNK_PASSWORD=rivendell
    volumes:
      - splunk_etc:/opt/splunk/etc
      - splunk_var:/opt/splunk/var
      - /tmp/rivendell:/tmp/elrond/output:ro  # Mount output directory for monitoring
    networks:
      - rivendell-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # Elasticsearch
  elastic:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: rivendell-elastic
    hostname: elastic
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - ELASTIC_PASSWORD=rivendell
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    volumes:
      - elastic_data:/usr/share/elasticsearch/data
    networks:
      - rivendell-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:rivendell http://localhost:9200/_cluster/health | grep -q '\"status\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # Elasticsearch setup - initializes passwords for built-in users
  elastic-setup:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: rivendell-elastic-setup
    depends_on:
      elastic:
        condition: service_healthy
    networks:
      - rivendell-network
    environment:
      - ELASTIC_PASSWORD=rivendell
    command: >
      bash -c '
        echo "Waiting for Elasticsearch to be ready...";
        until curl -s -u elastic:rivendell http://elastic:9200/_cluster/health | grep -q "status"; do
          sleep 5;
        done;
        echo "Setting kibana_system password...";
        curl -s -X POST -u elastic:rivendell -H "Content-Type: application/json" \
          http://elastic:9200/_security/user/kibana_system/_password \
          -d "{\"password\": \"rivendell\"}" || true;
        echo "Creating admin user with superuser role...";
        curl -s -X POST -u elastic:rivendell -H "Content-Type: application/json" \
          http://elastic:9200/_security/user/admin \
          -d "{\"password\": \"rivendell\", \"roles\": [\"superuser\"], \"full_name\": \"Admin User\"}" || true;
        echo "Elasticsearch setup complete!";
      '
    restart: "no"

  # Kibana
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: rivendell-kibana
    hostname: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elastic:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=rivendell
      - SERVER_NAME=rivendell-kibana
      - XPACK_SECURITY_ENABLED=true
    depends_on:
      elastic:
        condition: service_healthy
    networks:
      - rivendell-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:5601/api/status | grep -q 'available'"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 512M

  # Kibana dashboard setup - imports Rivendell dashboards
  kibana-setup:
    image: curlimages/curl:latest
    container_name: rivendell-kibana-setup
    depends_on:
      kibana:
        condition: service_healthy
    networks:
      - rivendell-network
    environment:
      - KIBANA_URL=http://kibana:5601
      - ELASTIC_USER=elastic
      - ELASTIC_PASSWORD=rivendell
    volumes:
      - ./src/web/kibana:/dashboards:ro
    command: >
      sh -c '
        echo "Rivendell Kibana Dashboard Setup";
        echo "=================================";

        echo "Importing Rivendell dashboards...";
        response=$$(curl -s -X POST \
          -u "elastic:rivendell" \
          "http://kibana:5601/api/saved_objects/_import?overwrite=true" \
          -H "kbn-xsrf: true" \
          --form file=@/dashboards/dashboards.ndjson);

        if echo "$$response" | grep -q "success.*true"; then
          echo "Dashboards imported successfully!";
        else
          echo "Dashboard import response: $$response";
        fi;

        echo "Setting default index pattern...";
        curl -s -X POST \
          -u "elastic:rivendell" \
          "http://kibana:5601/api/kibana/settings" \
          -H "kbn-xsrf: true" \
          -H "Content-Type: application/json" \
          -d "{\"changes\":{\"defaultIndex\":\"rivendell-index-pattern\"}}" > /dev/null;

        echo "";
        echo "Kibana setup complete!";
        echo "  - Overview: http://localhost:5601/app/dashboards#/view/rivendell-overview";
        echo "  - MITRE ATT&CK: http://localhost:5601/app/dashboards#/view/rivendell-mitre";
        echo "  - Analysis: http://localhost:5601/app/dashboards#/view/rivendell-analysis";
        echo "  - IoCs: http://localhost:5601/app/dashboards#/view/rivendell-iocs";
        echo "  - Keywords: http://localhost:5601/app/dashboards#/view/rivendell-keywords";
        echo "  - YARA: http://localhost:5601/app/dashboards#/view/rivendell-yara";
        echo "  - Actors: http://localhost:5601/app/dashboards#/view/rivendell-actors";
      '
    restart: "no"

  # ATT&CK Navigator
  navigator:
    image: node:18-alpine
    container_name: rivendell-navigator
    hostname: navigator
    ports:
      - "5602:4200"
    working_dir: /navigator
    volumes:
      - navigator_data:/navigator
    networks:
      - rivendell-network
    restart: unless-stopped
    command: >
      sh -c "
      if [ ! -d 'attack-navigator' ]; then
        echo 'Cloning ATT&CK Navigator...' &&
        apk add --no-cache git curl &&
        git clone --depth 1 https://github.com/mitre-attack/attack-navigator.git &&
        cd attack-navigator/nav-app &&
        echo 'Installing dependencies...' &&
        npm install &&
        echo 'Building Navigator (this may take a few minutes)...' &&
        NODE_OPTIONS='--max-old-space-size=3072' npm run build -- --output-path=/navigator/dist;
      fi &&
      if [ ! -f '/navigator/dist/assets/enterprise-attack.json' ]; then
        echo 'Downloading MITRE ATT&CK Enterprise v13.1 data...' &&
        mkdir -p /navigator/dist/assets &&
        curl -sL 'https://raw.githubusercontent.com/mitre/cti/ATT%26CK-v13.1/enterprise-attack/enterprise-attack.json' -o /navigator/dist/assets/enterprise-attack.json;
      fi &&
      echo 'Serving Navigator on port 4200...' &&
      npx serve -s /navigator/dist -l 4200
      "
    deploy:
      resources:
        limits:
          memory: 4G

volumes:
  postgres_data:
  redis_data:
  rivendell_output:
  rivendell_uploads:
  splunk_etc:
  splunk_var:
  elastic_data:
  navigator_data:

networks:
  rivendell-network:
    driver: bridge
